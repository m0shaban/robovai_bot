{% extends "base.html" %} {% block title %}ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯ - RoboVAI{% endblock %}
{% block content %}
<div class="h-[calc(100vh-100px)] flex gap-6 overflow-hidden">
  <!-- Sidebar: Conversations List -->
  <div class="w-1/3 glass-card flex flex-col">
    <div class="p-4 border-b border-slate-700">
      <h2 class="text-lg font-bold text-slate-50 mb-2">ðŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h2>
      <select
        id="tenant_select"
        class="select-field text-sm"
        onchange="loadConversations()"
      >
        <option value="">-- Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ --</option>
        {% for tenant in tenants %}
        <option value="{{ tenant.api_key }}">{{ tenant.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div id="conversations-list" class="flex-1 overflow-y-auto p-2 space-y-2">
      <div class="text-center py-12 text-slate-400">
        <p>Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡</p>
      </div>
    </div>
  </div>

  <!-- Main Area: Chat Window -->
  <div class="flex-1 glass-card flex flex-col relative">
    <!-- Chat Header -->
    <div
      id="chat-header"
      class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50 rounded-t-2xl"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl"
        >
          ðŸ‘¤
        </div>
        <div>
          <h3 class="font-bold text-slate-200" id="active-user-name">
            Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©
          </h3>
          <p class="text-xs text-slate-500" id="active-user-phone">...</p>
        </div>
      </div>
    </div>

    <!-- Messages Area -->
    <div
      id="chat-messages"
      class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/30"
    >
      <div class="h-full flex items-center justify-center text-slate-500">
        <div class="text-center">
          <div class="text-4xl mb-2">ðŸ‘‹</div>
          <p>Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t border-slate-700 bg-slate-800/50 rounded-b-2xl">
      <form
        id="reply-form"
        class="flex gap-2"
        hx-post="/ui/inbox/send"
        hx-target="#chat-messages"
        hx-swap="beforeend"
        hx-on::after-request="this.reset()"
      >
        <input type="hidden" name="tenant_api_key" id="input-tenant-key" />
        <input type="hidden" name="lead_id" id="input-lead-id" />

        <input
          type="text"
          name="message"
          placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
          class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-slate-200 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all"
          disabled
        />

        <button
          type="submit"
          class="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-3 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Ø¥Ø±Ø³Ø§Ù„ ðŸš€
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  function loadConversations() {
    const apiKey = document.getElementById('tenant_select').value;
    document.getElementById('input-tenant-key').value = apiKey;
    if (apiKey) {
      htmx.ajax(
        'GET',
        '/ui/inbox/conversations?tenant_api_key=' + encodeURIComponent(apiKey),
        { target: '#conversations-list' }
      );
    }
  }

  function loadChat(leadId, name, phone) {
    const apiKey = document.getElementById('tenant_select').value;

    // Update Header
    document.getElementById('active-user-name').textContent =
      name || 'Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    document.getElementById('active-user-phone').textContent = phone || '';

    // Update Input Form
    document.getElementById('input-lead-id').value = leadId;
    document.querySelector(
      '#reply-form input[name="message"]'
    ).disabled = false;
    document.querySelector('#reply-form button').disabled = false;

    // Load Messages
    htmx.ajax(
      'GET',
      `/ui/inbox/messages/${leadId}?tenant_api_key=${encodeURIComponent(
        apiKey
      )}`,
      { target: '#chat-messages' }
    );

    // Highlight active conversation
    document
      .querySelectorAll('.conversation-item')
      .forEach((el) =>
        el.classList.remove('bg-slate-700', 'border-cyan-500/50')
      );
    document
      .getElementById(`conv-${leadId}`)
      .classList.add('bg-slate-700', 'border-cyan-500/50');
  }
</script>
{% endblock %}
